
fillPrimes = (num_wanted, cb)->
  primes =   [2]
  candidate = 3
  while primes.length < num_wanted
    i = 0
    sqrt = Math.sqrt candidate
    prime = true
    console.log "step 1; i=#{i} sqrt=#{sqrt} primes=#{primes}"
    await setTimeout defer(), 0
    console.log "step 2; i=#{i} sqrt=#{sqrt} primes=#{primes}"
    while primes[i] <= sqrt
      console.log "step 3; i=#{i} sqrt=#{sqrt} primes=#{primes}"
      if (candidate % primes[i]) == 0
        prime = false
        break
      i++
    console.log "step 4; i=#{i} sqrt=#{sqrt} primes=#{primes}"
    primes.push candidate if prime
    candidate++
  cb primes

await fillPrimes 1000, defer primes
